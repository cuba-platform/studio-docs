:sourcesdir: ../../../../source

[[jpa_support]]
=== Включение функций поддержки JPA
--
Поддержка стандарта JPA (Java Persistence Annotation) предоставляется плагином *Java EE: EJB, JPA, Servlets*.
[WARNING]
====
Функциональность, описанная ниже, недоступна в CUBA Studio IDE или в IntelliJ IDEA Community Edition.
====

Поддержка JPA стандарта предоставляет следующие функции, полезные для разработки CUBA приложений:

- JPQL запросы: подсветка синтаксиса, автодополнение и инспекции,
- Консоль JPQL запросов (JPA Console, для проектов основанных на CUBA 7.1 или выше),
- Инспекции исходного кода сущностей,
- ER диаграмма,
- Другие возможности, описанные на https://www.jetbrains.com/help/idea/overview-of-jpa-support.html[сайте JetBrains].

Чтобы воспользоваться этими возможностями, вам нужно настроить две вещи в вашем проекте:

- Настроить Data Source для базы данных, соответствующей главному хранилищу данных,
- Добавить JPA фасеты (facet) для всех модулей проекта.

Studio помогает быстрее выполнить обе эти задачи. Инструкции в следующих секциях актуальны для версии IDEA 2019.2.
--

[[jpa_support_datasource]]
==== Настройка Data Source
--
Вы можете настроить Data Source (источник данных) вручную с помощью окна инструментов (tool window) *Database*, расположенного на правой кромке окна IDE.
Но Studio предоставляет и автоматическое обнаружение источника данных при открытии проекта:

image::features/jpa_support/datasource-notification.png[align="center"]

Если вы пропустили уведомление, оно также записывается в окно инструментов *Event Log*, которое можно открыть, нажав на соответствующую кнопку в правом нижнем углу экрана.

Нажмите *Configure*, и откроется предзаполненный диалог *Data Sources and Drivers*.

image::features/jpa_support/add-ds-dialog.png[align="center"]

Механизм обнаружения источника данных автоматически определяет параметры на основании настроек главного хранилища данных и заполняет параметр Driver и другие свойства подключения. Вам нужно только настроить драйвер базы данных в диалоге "Data Sources and Drivers":

- Нажмите ссылку *Download missing driver files* в нижней части диалога. Файлы драйвера будут скачаны автоматически.
- Нажмите *Test Connection*, чтобы убедиться, что настройки подключения определены корректно. Измените их если необходимо.
- Поменяйте значение поля *Save* на *Forever*. Иначе пароль будет забыт после перезапуска IDE.
- Закройте диалог, выбрав кнопку *OK*.

Если JPA фасеты уже созданы, назначьте для них созданный Data Source, открыв окно инструментов *Persistence*. Правый клик мыши по каждому фасету -> *Assign Data Sources...* -> сменить Data Source -> *OK*.

--

[[jpa_support_facets]]
==== Настроить JPA фасеты
Каждый модуль в проекте должен иметь настроенный *JPA* фасет, иначе возможности, связанные с JPQL запросами, не будут доступны в этом модуле.

Автообнаружение JPA фасетов::
+
--
Studio помогает вам, автоматически обнаруживая фасеты. При первом открытии проекта вы увидите уведомление *Frameworks Detected* в правом нижнем углу окна IDE:

image::features/jpa_support/facet-detection.png[align="center"]

Если JPA фасеты уже были настроены в вашем проекте, уведомление не появится. Чтобы получить уведомление, вы можете открыть диалог из главного меню -> *File* -> *Project Structure* и удалить существующие фасеты. Затем переоткройте проект и выполните обновление проекта Gradle (окно инструментов *Gradle* -> кнопка *Reimport All Gradle Projects*).

Если вы пропустили уведомление, оно также записывается в окно инструментов *Event Log*:

image::features/jpa_support/event-log.png[align="center"]

Нажмите ссылку *Configure*, и откроется диалог *Setup Framework*.

Снимите флажки с элементов группы *Web* и нажмите *OK*:

image::features/jpa_support/setup-frameworks.png[align="center"]

Чтобы проверить, что фасет настроен корректно, откройте окно инструментов *Persistence*, расположенное на левой кромке окна IDE . Затем раскройте один из узлов, например тот, что относится к модулю *app-global*, и раскройте под-узел *Entities*. Вы должны увидеть список сущностей, определенных в вашем проекте или унаследованных из аддонов:

image::features/jpa_support/persistence-tool-window.png[align="center"]
--

Ручная настройка JPA фасета::
+
--
Можно также настроить JPA фасеты вручную через диалог *File* -> *Project Structure*.

- Откройте диалог *Project Structure*,
- Выберите пункт *Facets* в левом меню,
- Удалите все существующие фасеты JPA,
- Для всех модулей вашего проекта: global, core, gui, web, portal - проделайте следующие действия:
- Нажмите иконку "+" (Add),
- Выберите тип фасета JPA,
- Выберите под-модуль с названием, оканчивающимся на "main", например "sample-sales.app-global.main". Нажмите *OK*.
- В нижней правой части диалога поменяйте *Default JPA Provider* на *CUBA EclipseLink*.
- Повторите эти шаги для других модулей.

[TIP]
====
Не забудьте поменять поле *Default JPA Provider* на *CUBA EclipseLink*, иначе консоль JPA запросов не будет работать.
====

image::features/jpa_support/add-facet-manually.png[align="center"]

--

==== Примеры возможностей
--
JPQL запросы: подсветка синтаксиса, автодополнение и инспекции - работают в Java и XML файлах для модулей, где JPA фасет сконфигурирован:

image::features/jpa_support/jpql_highlighting.png[align="center"]
image::features/jpa_support/jpql_java.png[align="center"]

Entity-relation (ER) диаграмму можно открыть из окна инструментов *Persistence*: правый клик по любому модулю -> *Entities* -> *ER Diagram*. Возможно вы захотите включить опцию *Superclasses* вверху диаграммы, чтобы отключить показ общих базовых классов:

image::features/jpa_support/er_diagram.png[align="center"]

JPA консоль::

[TIP]
====
JPA консоль доступна только для проектов, использующих 7.1 или более позднюю версию CUBA.
====

JPA консоль открывается через окно инструментов *Persistence*: развернуть любой модуль -> выделить пункт *Entities* и затем нажать кнопку *Console*:

image::features/jpa_support/jpa_console_button.png[align="center"]

Окно консоли откроется. Теперь вы можете выполнять JPQL запросы на БД, подключенной к проекту:

image::features/jpa_support/jpa_console.png[align="center"]

--