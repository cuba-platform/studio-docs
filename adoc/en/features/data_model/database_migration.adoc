:sourcesdir: ../../../../source

[[database_migration]]
==== Database Migration

Studio is capable of creating DDL scripts for keeping your database schema up-to-date with the project's data model. The generated scripts can be executed either from Studio, directly by {main_man_url}/db_update_gradle.html[Gradle tasks] or by the application itself {main_man_url}/db_update_server.html[on startup].

Creating DDL scripts is performed for:

* Main data store.
* Additional data stores with *Create and Update* and *Update Only* schema management modes.

Generation of the DDL scripts can be started by the following actions:

* From the main menu: *CUBA > Generate Database Scripts* - for all data stores.
* Select *Data Model* in the project tree and click *Generate Database Scripts* in the context menu - for all data stores.
* Select node in the CUBA project tree corresponding to the particular data store, right-click to open context menu and choose *Generate Database Scripts* item - to generate database scripts for one data store only.

Studio will open the *Database Scripts* window:

image::features/data_model/database_scripts_dialog.png[align="center"]

The panel on the left displays database script sections grouped by data stores which they belong to. Only data stores supporting DDL scripts are shown.

Database scripts are divided into the following sections:

Updates::
+
--
The *Updates* section displays scripts for updating the database to the current state of the data model. The table on the right displays the list of scripts with script text located in the bottom. If your project contains not yet applied update scripts, the corresponding section in the left tree is highlighted. Saved scripts are located in the `modules/core/db/update` or `modules/core/db/update_{additional_data_store_name}` directory. The scripts have autogenerated names with prefixes that ensure the order of execution. Scripts containing DROP statements are highlighted in red.

You can add an arbitrary script by clicking the image:plus_button.png[Create] button, it will be saved and executed later together with auto-generated scripts.

The newly generated scripts can be edited or completely deleted by clicking the image:remove_button.png[Remove] button.

If you click image:exclude_button.png[Exclude selected] (exclude), you will have two options:

* Move the script to the directory of manually executed scripts: `modules/core/db/update-manually` or `modules/core/db/update-manually_{additional_data_store_name}`. Then the script will not be executed automatically when you run *Update database*, but you will be able to run it manually when needed. This option is useful for scripts that drop columns or tables renamed earlier to `*__UNUSED`.
* Exclude the script: it will not be saved to the `modules/core/db/update` directory, but remembered in the `studio-intellij.xml` file in your project folder. When you generate scripts next time, Studio will ignore changes, corresponding to the excluded scripts. This allows you to maintain difference between the database and the model entities.
+
For example, you may want to add a database field to a table, corresponding to a project entity, but do not map it to an entity attribute. When Studio generates a script to delete the field from the database, just exclude it, and Studio will never generate it again.
--

Init Tables::
+
--
The *Init Tables* script creates all tables when you execute *Create Database*. It is executed before the *Init constraints* and *Init data* scripts. You can edit the script, but keep the comments dividing tables. The script is saved into the `10.create-db.sql` file.
--

Init Constraints::
+
--
The *Init Constraints* script creates referential integrity constraints. It is executed immediately after the *Init tables* script. You can edit the script, but keep the comments dividing tables. The script is saved into the `20.create-db.sql` file.
--

Init Data::
+
--
The *Init Data* script allows you to insert additional data or schema information not present in the data model. It is executed at the end of initialization. The script is saved into the `30.create-db.sql` file.
--

If the project contains an application component (add-on) that does not provide DDL scripts for the current database, Studio generates scripts for this component and shows them in the *Init {component} tables* and *Init {component} constraints* sections. The scripts are saved in `01.{component}-create-db.sql` and `02.{component}-create-db.sql` files respectively.

Click *Save and close* to save all generated scripts. You can find the scripts in the *Project > Data Stores > Main Data Store* project tree section.

In order to run the update scripts, stop the application server if it is running and execute *Update Database* or *Update All Databases* from the *CUBA* main menu. If you want to update only one data store, select corresponding node in the CUBA project tree, right-click to open context menu and choose *Update Database* item.

If you want to re-create the database from scratch with the init scripts, execute *Create Database* or *Create All Databases*. To re-create only one database, select the corresponding data store node in the CUBA project tree, right-click to open context menu and choose *Create Database* item.

[[migration_entity_ddl_settings]]
Entity DDL Generation Settings::
--
You can customize Studio database migration scripts generation behavior on the entity level. The *Designer* tab of the <<data_model_entity,Entity Designer>> allows you to configure *DDL generation settings* for the edited entity:

image::features/data_model/entity_ddl_gen_settings.png[align="center"]

* *DB script generation mode* - select suitable mode:
** *CREATE_AND_DROP* - when generating DDL scripts, Studio can create table, columns and constraints in the database as well as drop any of its columns or constraints if corresponding attributes are missing in the data model. Both *init* and *update* scripts are generated according to the data model. Default mode.
** *CREATE_ONLY* - Studio will not attempt to drop table columns or constraints when generating database *update* scripts. *Init* scripts are generated according to the data model.
** *DISABLED* - Studio will not generate database *init* and *update* scripts at all for this entity.
* *Unmapped columns* - list of columns that exist in the database table but are not mapped to entity attributes. Studio will not attempt to drop columns mentioned in this list.
* *Unmapped constraints* - list of constraints that exist in the database table but are not mapped to entity attributes. Studio will not attempt to drop them in the database update scripts.

These settings can also be specified manually in the source code, see the `com.haulmont.cuba.core.global.DdlGeneration` annotation (available since platform version 7.1.6 and 7.2.2).
--
