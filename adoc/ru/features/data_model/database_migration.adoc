:sourcesdir: ../../../../source

[[database_migration]]
==== Работа с базой данных

Studio умеет создавать DDL-скрипты для создания и поддержания схемы базы данных, соответствующей моделируемым сущностям. Созданные скрипты могут быть выполнены как с помощью Studio, так и прямым вызовом {main_man_url}/db_update_gradle.html[задач Gradle], а также самим приложением {main_man_url}/db_update_server.html[при его запуске].

Генерация DDL-скриптов выполняется для:

* Главного хранилища данных.
* Дополнительных хранилищ данных, у которых режим управления схемой БД имеет значения: *Create and Update* или *Update Only*.

Генерацию DDL-скриптов можно запустить следующими действиями:

* Из главного меню: *CUBA > Generate Database Scripts* - для всех хранилищ данных.
* Выбрать *Data Model* в дереве проекта и выбрать действие *Generate Database Scripts* в контекстном меню - для всех хранилищ данных.
* Выбрать узел, соответствующий конкретному хранилищу данных, в дереве проекта CUBA, открыть контекстное меню и выбрать пункт *Generate Database Scripts* - чтобы сгенерировать DDL-скрипты только для одного хранилища данных.

Studio откроет окно *Database Scripts*:

image::features/data_model/database_scripts_dialog.png[align="center"]

Панель слева отображает секции скриптов, сгруппированные по хранилищу данных, к которому они относятся. Показаны только те хранилища данных, которые поддерживают DDL-скрипты.

Скрипты миграции БД поделены на следующие секции:

Updates::
+
--
В секции *Updates* отображаются скрипты обновления базы данных для её соответствия текущему состоянию модели данных приложения. Таблица справа отображает список скриптов, а текст скрипта располагается внизу. Если ваш преокт содержит еще не примененные скрипты обновления, соответствующая секция в левом дерева подсвечивается. Созданные скрипты сохраняются в каталоге `modules/core/db/update` или `modules/core/db/update_{название_дополнительного_хранилища_данных}`. Имена скриптов генерируются автоматически и содержат префиксы, которые определяют порядок выполнения скриптов. Скрипты, содержащие команду DROP, подсвечиваются красным.

Вы можете добавить дополнительный скрипт, нажав на кнопку image:plus_button.png[Create], он будет сохранён и позже выполнен вместе с остальными сгенерированными скриптами.

Новые скрипты можно отредактировать или удалить совсем, нажав на кнопку image:remove_button.png[Remove].

Если нажать на кнопку image:exclude_button.png[Exclude selected] (исключить), вам будут предложены два варианта:

* Перенести скрипт в папку с исключёнными вручную скриптами: `modules/core/db/update-manually` или `modules/core/db/update-manually_{название_дополнительного_хранилища_данных}`. В этом случае скрипт не будет исполнен автоматически при выполнении команды *Update database*, но вы всегда сможете выполнить его вручную, когда потребуется. Этот вариант удобен для скриптов, удаляющих столбцы и таблицы, ранее переименованные в `*__UNUSED`.
* Исключить скрипт: в этом случае он не будет сохранён в папке `modules/core/db/update`, но будет зафиксирован в файле `studio-intellij.xml` в каталоге проекта. В следующий раз, когда вы будете генерировать скрипты, Studio проигнорирует изменения, соответствующие исключённым скриптам. Этот вариант позволяет иметь различия между схемой БД и сущностями модели данных приложения.
+
Например, вам может понадобиться добавить поле в таблицу БД, соответствующую некой сущности, не сопоставляя его с атрибутом сущности. Когда Studio создаст скрипт для удаления этого поля из базы данных, просто исключите его, и Studio не будет генерировать его снова.
--

Init Tables::
+
--
Скрипт *Init Tables* создаёт все таблицы в базе данных при выполнении команды *Create Database*. Он выполняется до скриптов *Init constraints* и *Init data*. Вы можете редактировать этот скрипт, но обязательно сохраните комментарии, разделяющие таблицы. Скрипт хранится в файле `10.create-db.sql`.
--

Init Constraints::
+
--
Скрипт *Init Constraints* служит для создания ограничений целостности. Он выполняется сразу после *Init tables*. Этот скрипт также можно редактировать, не удаляя комментариев-разделителей. Скрипт хранится в файле `20.create-db.sql`.
--

Init Data::
+
--
Скрипт *Init Data* позволяет добавить дополнительную информацию или схему, которой нет в модели данных. Этот скрипт выполняется последним при инициализации БД. Скрипт хранится в файле `30.create-db.sql`.
--

Если проект содержит компоненты приложения (аддоны), для которых нет DDL-скриптов для текущей базы данных, Studio сама создаст скрипты для этих компонентов и отобразит их в секциях *Init {component} tables* и *Init {component} constraints*. Такие скрипты сохраняются в файлах `01.{component}-create-db.sql` и `02.{component}-create-db.sql` соответственно.

Нажмите *Save and close* для сохранения сгенерированных скриптов. Теперь вы можете найти их в секции *Project > Data Stores > Main Data Store* дерева проекта.

Чтобы запустить скрипты обновления, остановите сервер приложения, если он был запущен, и выполните команду *Update Database* или *Update All Databases* в главном меню *CUBA*. Если вы хотите обновить только одно хранилище данных, выберите соответствующий узел в дереве проекта CUBA, откройте контекстное меню и выберите пункт *Update Database*.

Если вы хотите заново создать базу данных с нуля с помощью скриптов инициализации, выполните команду *Create Database* или *Create All Databases*. Чтобы пересоздать только одну базу данных, выберите соответствующий узел в дереве проекта CUBA, откройте контекстное меню и выберите пункт *Create Database*.

[[migration_entity_ddl_settings]]
Настройки генерации DDL на уровне сущности::
--
Вы можете изменить поведение Studio при генерации скриптов миграции БД на уровне отдельной сущности. Вкладка *Designer* <<data_model_entity,дизайнера сущностей>> позволяет вам настроить *DDL generation settings* для редактируемой сущности:

image::features/data_model/entity_ddl_gen_settings.png[align="center"]

* *DB script generation mode* - выберите подходящий режим:
** *CREATE_AND_DROP* - при генерации DDL-скриптов Studio может создавать в БД таблицу, столбцы и ограничения, так же как и удалять любые из ее столбцов или ограничений, если соответствующие атрибуты отсутствуют в модели данных. И *init* и *update* скрипты генерируются согласно модели данных. Режим используется по умолчанию.
** *CREATE_ONLY* - Studio не будет пытаться удалять столбцы или ограничения из таблицы при генерации *update* скриптов БД. *Init* скрипты генерируются согласно модели данных.
** *DISABLED* - Studio совсем не будет генерировать *init* и *update* скрипты для этой сущности.
* *Unmapped columns* - список столбцов, которые существуют в таблице БД, но для которых нет соответствующих атрибутов сущности. Studio не будет предлагать удалить столбцы, указанные в этом списке.
* *Unmapped constraints* - список ограничений, которые существуют в таблице БД, но для которых нет соответствующих атрибутов (ссылочных) сущности. Studio не будет предлагать удалить их в скриптах обновления БД.

Эти настройки могут быть также указаны вручную в исходном коде, см. аннотацию `com.haulmont.cuba.core.global.DdlGeneration` (доступна начиная с версий платформы 7.1.6 и 7.2.2).
--
