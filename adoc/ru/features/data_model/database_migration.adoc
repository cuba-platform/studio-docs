:sourcesdir: ../../../../source

[[database_migration]]
==== Работа с базой данных

Studio умеет создавать DDL-скрипты для создания и поддержания схемы базы данных, соответствующей моделируемым сущностям. Созданные скрипты могут быть выполнены как с помощью Studio, так и прямым вызовом {main_man_url}/db_update_gradle.html[задач Gradle], а также самим приложением {main_man_url}/db_update_server.html[при его запуске].

Для того, чтобы создать DDL-скрипты средствами Studio, нажмите *CUBA > Generate Database Scripts* в главном меню, либо выберите элемент *Data Model* в дереве проекта и нажмите *Generate Database Scripts* в его контекстном меню.

Откроется окно Studio *Database Scripts*, которое содержит следующие вкладки:

Updates::
+
--
На вкладке *Updates* отображаются скрипты обновления базы данных для её соответствия текущему состоянию модели данных приложения. Созданные скрипты сохраняются в каталоге `modules/core/db/update`. Имена скриптов генерируются автоматически и содержат префиксы, которые определяют порядок выполнения скриптов. Скрипты, содержащие команду DROP, подсвечиваются красным.

Вы можете добавить дополнительный скрипт, нажав на кнопку image:plus_button.png[Create], он будет сохранён и позже выполнен вместе с остальными сгенерированными скриптами.

Новые скрипты можно отредактировать или удалить совсем, нажав на кнопку image:remove_button.png[Remove].

Если нажать на кнопку image:exclude_button.png[Exclude selected] (исключить), вам будут предложены два варианта:

* Перенести скрипт в папку с исключёнными вручную скриптами: `modules/core/db/update-manually`. В этом случае скрипт не будет исполнен автоматически при выполнении команды *Update database*, но вы всегда сможете выполнить его вручную, когда потребуется. Этот вариант удобен для скриптов, удаляющих столбцы и таблицы, ранее переименованные в `*__UNUSED`.
* Исключить скрипт: в этом случае он не будет сохранён в папке `modules/core/db/update`, но будет зафиксирован в файле `studio-intellij.xml` в каталоге проекта. В следующий раз, когда вы будете генерировать скрипты, Studio проигнорирует изменения, соответствующие исключённым скриптам. Этот вариант позволяет иметь различия между схемой БД и сущностями модели данных приложения.
+
Например, вам может понадобиться добавить поле в таблицу БД, соответствующую некой сущности, не сопоставляя его с атрибутом сущности. Когда Studio создаст скрипт для удаления этого поля из базы данных, просто исключите его, и Studio не будет генерировать его снова.
--

Init Tables::
+
--
Скрипт *Init Tables* создаёт все таблицы в базе данных при выполнении команды *Create Database*. Он выполняется до скриптов *Init constraints* и *Init data*. Вы можете редактировать этот скрипт, но обязательно сохраните комментарии, разделяющие таблицы. Скрипт хранится в файле `10.create-db.sql`.
--

Init Constraints::
+
--
Скрипт *Init Constraints* служит для создания ограничений целостности. Он выполняется сразу после *Init tables*. Этот скрипт также можно редактировать, не удаляя комментариев-разделителей. Скрипт хранится в файле `20.create-db.sql`.
--

Init Data::
+
--
Скрипт *Init Data* позволяет добавить дополнительную информацию или схему, которой нет в модели данных. Этот скрипт выполняется последним при инициализации БД. Скрипт хранится в файле `30.create-db.sql`.
--

Если проект содержит компоненты приложения (аддоны), для которых нет DDL-скриптов для текущей базы данных, Studio сама создаст скрипты для этих компонентов и отобразит их на вкладках *Init {component} tables* и *Init {component} constraints*. Такие скрипты сохраняются в файлах `01.{component}-create-db.sql` и `02.{component}-create-db.sql` соответственно.

Нажмите *Save and close* для сохранения сгенерированных скриптов. Теперь вы можете найти их в секции *Project > Data Stores > Main Data Store* дерева проекта.

Чтобы запустить скрипты обновления, остановите сервер приложения, если он был запущен, и выполните команду *Update Database* в главном меню *CUBA*. Если вы хотите заново создать базу данных с нуля с помощью скриптов инициализации, выполните команду *Create Database*.
